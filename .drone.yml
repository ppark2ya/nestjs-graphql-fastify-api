# ================================================================
# Drone CI Pipeline Configuration
# Gateway와 Auth를 분리된 파이프라인으로 빌드
# ================================================================

# ================== Gateway Pipeline ==================
kind: pipeline
type: docker
name: gateway

trigger:
  branch:
    - develop
    - dev-*
  event:
    - push
    - tag

steps:
  - name: build-and-push-gateway
    image: plugins/docker
    settings:
      dockerfile: apps/gateway/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_gateway
      tags:
        - ${DRONE_TAG:-${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:8}}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success

---
# ================== Auth Pipeline ==================
kind: pipeline
type: docker
name: auth

trigger:
  branch:
    - develop
    - dev-*
  event:
    - push
    - tag

steps:
  - name: build-and-push-auth
    image: plugins/docker
    settings:
      dockerfile: apps/auth/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_auth
      tags:
        - ${DRONE_TAG:-${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:8}}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success
