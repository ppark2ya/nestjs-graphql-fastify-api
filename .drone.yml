# ================================================================
# Drone CI Pipeline Configuration
# Gateway와 Auth를 분리된 파이프라인으로 빌드
# 각 서비스 관련 소스가 변경될 때만 트리거
# ================================================================

# ================== Gateway Pipeline ==================
kind: pipeline
type: docker
name: gateway

trigger:
  branch:
    - develop
    - dev-*
  event:
    - push
    - tag
  paths:
    include:
      - apps/gateway/**
      - libs/shared/**
      - package.json
      - pnpm-lock.yaml
      - tsconfig.base.json
      - nest-cli.json
      - nx.json
      - .swcrc

steps:
  - name: build-and-push-gateway
    image: plugins/docker
    settings:
      dockerfile: apps/gateway/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_gateway
      tags:
        - ${DRONE_TAG:-${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:8}}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success

---
# ================== Auth Pipeline ==================
kind: pipeline
type: docker
name: auth

trigger:
  branch:
    - develop
    - dev-*
  event:
    - push
    - tag
  paths:
    include:
      - apps/auth/**
      - libs/shared/**
      - package.json
      - pnpm-lock.yaml
      - tsconfig.base.json
      - nest-cli.json
      - nx.json
      - .swcrc

steps:
  - name: build-and-push-auth
    image: plugins/docker
    settings:
      dockerfile: apps/auth/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_auth
      tags:
        - ${DRONE_TAG:-${DRONE_BRANCH}-${DRONE_COMMIT_SHA:0:8}}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success
---
# ================== Gateway Pipeline ==================
kind: pipeline
type: docker
name: gateway

trigger:
  event:
    - tag
  ref:
    - refs/tags/v*

steps:
  - name: build-and-push-gateway
    image: plugins/docker
    settings:
      dockerfile: apps/gateway/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_gateway
      tags:
        - ${DRONE_TAG}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success

---
# ================== Auth Pipeline ==================
kind: pipeline
type: docker
name: auth

trigger:
  event:
    - tag
  ref:
    - refs/tags/v*

steps:
  - name: build-and-push-auth
    image: plugins/docker
    settings:
      dockerfile: apps/auth/Dockerfile
      context: .
      repo:
        from_secret: docker_repo_auth
      tags:
        - ${DRONE_TAG}
        - latest
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
    when:
      status:
        - success